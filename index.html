<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Night City Datapad 2045</title>
    
    <!-- PWA & Mobile Meta Tags -->
    <meta name="theme-color" content="#0a0a0a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NC Datapad">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,700;1,800&display=swap');

        :root {
            --neon-red: #ff0000;
            --dark-bg: #0a0a0a;
            --zinc-900: #18181b;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--dark-bg);
            color: #ef4444;
            overflow: hidden;
            overscroll-behavior-y: contain;
        }

        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.1;
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .glitch-active {
            animation: glitch 0.2s infinite;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #dc2626; }

        .map-district { transition: all 0.3s ease; cursor: pointer; }
        .map-district:hover { fill-opacity: 0.7; stroke-width: 1.5; }

        .audio-bar {
            width: 4px;
            background-color: #dc2626;
            transition: height 0.1s ease;
        }

        .qr-container {
            filter: grayscale(1) contrast(1.5) brightness(1.2) sepia(1) hue-rotate(-50deg);
        }

        .music-wave {
            display: flex;
            align-items: flex-end;
            gap: 1px;
            height: 10px;
        }
        .music-bar {
            width: 2px;
            background: #ef4444;
            height: 2px;
        }
        .music-bar.playing {
            animation: wave 0.6s infinite ease-in-out alternate;
        }
        @keyframes wave {
            from { height: 2px; }
            to { height: 10px; }
        }

        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-0 sm:p-4">

    <div class="scanlines"></div>
    <div class="fixed inset-0 opacity-10 pointer-events-none" 
         style="background-image: radial-gradient(#ff0000 1px, transparent 1px); background-size: 20px 20px;"></div>

    <audio id="bg-music" loop crossorigin="anonymous">
        <source src="https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/theme.mp3" type="audio/mpeg">
    </audio>

    <div id="datapad-frame" class="relative w-full max-w-2xl bg-zinc-900 border-x-0 sm:border-4 border-zinc-800 sm:rounded-xl overflow-hidden shadow-[0_0_50px_rgba(255,0,0,0.15)] flex flex-col h-screen sm:h-[90vh]">
        
        <div class="bg-zinc-800 p-2 safe-top flex justify-between items-center text-[10px] border-b border-red-900/50 z-20">
            <div class="flex items-center gap-4">
                <span class="flex items-center gap-1 font-bold">
                    <i data-lucide="shield-alert" class="w-3 h-3 text-red-600 animate-pulse"></i>
                    SYSTEM: RED_OS_v4.5
                </span>
            </div>
            <div class="flex items-center gap-3">
                <button id="music-btn" onclick="toggleMusic()" class="flex items-center gap-2 bg-black/40 px-2 py-1 border border-zinc-700 hover:border-red-500 transition-colors">
                    <div class="music-wave" id="music-wave-ui">
                        <div class="music-bar"></div>
                        <div class="music-bar"></div>
                        <div class="music-bar"></div>
                    </div>
                    <i data-lucide="music" class="w-3 h-3"></i>
                </button>
                <i data-lucide="wifi" class="w-3 h-3"></i>
                <div class="flex items-center gap-1">
                    <span>98%</span>
                    <i data-lucide="battery" class="w-3 h-3"></i>
                </div>
            </div>
        </div>

        <div id="screen-content" class="flex-1 relative p-6 overflow-y-auto custom-scrollbar bg-black/40 z-10 flex flex-col">
            
            <div id="lock-screen" class="flex flex-col items-center justify-center h-full flex-1 py-20 text-center">
                <i data-lucide="lock" class="w-12 h-12 mb-4 text-red-600"></i>
                <h2 class="text-xl font-bold mb-2 uppercase italic tracking-widest">Verschlüsselt</h2>
                <button onclick="decryptSystem()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-none border border-red-400 font-bold tracking-widest transition-all active:scale-95 shadow-lg">
                    INITIALISIEREN
                </button>
            </div>

            <div id="tab-message" class="hidden space-y-6 flex-1">
                <div class="border-l-4 border-red-600 pl-4 py-2 bg-red-950/20">
                    <h1 class="text-2xl font-black italic uppercase leading-none tracking-tighter text-red-500">WELT: TIME OF THE RED (2045)</h1>
                </div>
                <div class="space-y-4 text-sm leading-relaxed text-red-400/90">
                    <p>
                        Willkommen in den 2040ern, Choom. Die Welt, wie wir sie kannten, ist Asche. Der <span class="text-white font-bold">Vierte Konzernkrieg</span> hat den Planeten zerfetzt und den Himmel in ein bleibendes, blutiges Rot getaucht. Partikel in der Atmosphäre färben jeden Sonnenaufgang in die Farbe von vergossenem Blut.
                    </p>
                    <p>
                        Night City versucht sich mühsam aus den Trümmern der <span class="text-white font-bold">Atomexplosion von 2023</span> zu erheben. Das alte Corporate Center ist eine verstrahlte Todeszone, das globale NET wurde durch Viren zerstört und die Versorgungsketten sind kollabiert.
                    </p>
                    <p>
                        In dieser Ära überlebst du nicht durch Regeln, sondern durch <span class="text-yellow-500 font-bold uppercase">Style, Attitude und Edge</span>. Die großen Konzerne lecken ihre Wunden, während Gangs und Nomaden-Konvois die wahren Herrscher der Trümmerfelder sind. Es ist eine Zeit des Wiederaufbaus, der Improvisation und des gnadenlosen Überlebenskampfes.
                    </p>
                </div>
                <div class="bg-red-600/20 border border-red-500 p-4 font-bold italic shadow-lg text-xs">
                    <p>„Hör auf zu fragen, warum alles schiefgelaufen ist. Fang an zu fragen, wie du morgen noch atmest.“</p>
                </div>
                <div class="bg-zinc-900 border border-zinc-700 p-3 text-[10px] space-y-1">
                    <p class="text-white uppercase font-black">Aktuelle Mission:</p>
                    <p>Sucht das <span class="text-yellow-500">El Coyote Rojo</span> in Upper Marina auf. Meldet euch beim Eingang mit dem Code <span class="text-white italic">"Grey schickt uns"</span>.</p>
                </div>
            </div>

            <div id="tab-comms" class="hidden space-y-4 flex-1">
                <div class="relative aspect-video w-full bg-black border-2 border-zinc-800 rounded overflow-hidden">
                    <div id="comms-loading" class="absolute inset-0 flex flex-col items-center justify-center text-red-500 z-30">
                        <i data-lucide="cpu" class="w-8 h-8 animate-spin mb-2"></i>
                        <span class="text-[10px] animate-pulse uppercase tracking-[0.2em]">Signalaufbau...</span>
                    </div>
                    <div id="grey-feed-container" class="hidden absolute inset-0">
                        <img id="grey-image" src="" alt="Mr. Grey" class="w-full h-full object-cover grayscale opacity-70">
                        <div class="absolute inset-0 bg-red-900/10 mix-blend-overlay"></div>
                    </div>
                </div>
                <div class="bg-zinc-900/80 border border-zinc-800 p-4">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <button id="voice-btn" onclick="playVoice()" class="p-3 bg-red-600 rounded-full text-white hover:bg-red-500 transition-all active:scale-95 shadow-xl">
                                <i data-lucide="play" id="play-icon" class="w-5 h-5 fill-current"></i>
                            </button>
                            <div class="flex flex-col">
                                <p class="text-xs font-bold text-red-500 uppercase">Crypt-Vox Feed</p>
                                <p class="text-[8px] text-zinc-500">ID: GREY_REDUX_45</p>
                            </div>
                        </div>
                        <div id="visualizer" class="flex gap-1 h-6 items-end">
                            <div class="audio-bar h-1"></div><div class="audio-bar h-1"></div><div class="audio-bar h-1"></div><div class="audio-bar h-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEUE WELTKARTE MIT BILD-HINTERGRUND -->
            <div id="tab-map" class="hidden flex-col h-full flex-1">
                <div class="relative w-full flex-1 min-h-[300px] bg-zinc-950 border border-zinc-800 rounded overflow-hidden shadow-inner">
                    <!-- Das Night City Bild (lokale Datei oder Fallback) -->
                    <div class="absolute inset-0 bg-cover bg-center opacity-70" style="background-image: url('Night City 4K.jpg'), url('https://images.unsplash.com/photo-1518005020951-eccb494ad742?q=80&w=800&auto=format&fit=crop');"></div>
                    
                    <!-- Interaktive Overlay-Zonen -->
                    <svg viewBox="0 0 100 100" class="absolute inset-0 w-full h-full drop-shadow-lg" preserveAspectRatio="none">
                        <!-- Watson Area (Oben) -->
                        <path d="M 40 5 L 60 5 L 65 30 L 45 35 Z" class="map-district fill-blue-500/30 stroke-blue-400 stroke-[0.5]" onclick="showDistrictInfo('Watson', 'Aufbau', 'Nord-Distrikt. Ehemaliges Industriegebiet, nun ein Flickenteppich aus Baustellen.')"/>
                        
                        <!-- City Center / Spaceport (Mitte Links) -->
                        <path d="M 25 35 L 45 35 L 50 50 L 30 55 L 20 45 Z" class="map-district fill-red-600/40 stroke-red-500 stroke-[0.5]" onclick="showDistrictInfo('City Center', 'RADIOAKTIV', 'Ground Zero der alten Nuke von 2023. Teile sind noch immer verstrahlt.')"/>
                        
                        <!-- Heywood (Mitte Unten) -->
                        <path d="M 35 55 L 55 50 L 60 70 L 40 75 Z" class="map-district fill-yellow-500/30 stroke-yellow-400 stroke-[0.5]" onclick="showDistrictInfo('Heywood', 'Überfüllt', 'Das größte Wohngebiet von Night City. Brutales Pflaster, viel Gang-Aktivität.')"/>
                        
                        <!-- Pacifica (Unten Links) -->
                        <path d="M 30 70 L 40 75 L 45 90 L 25 85 Z" class="map-district fill-purple-500/30 stroke-purple-400 stroke-[0.5]" onclick="showDistrictInfo('Pacifica', 'Kampfzone', 'Ehemaliges Urlaubsparadies, jetzt komplett von Voodoo Boys und Gangs kontrolliert.')"/>
                        
                        <!-- Target Pin (El Coyote Rojo Bereich) -->
                        <circle cx="48" cy="62" r="1.5" fill="white" class="animate-ping" />
                        <circle cx="48" cy="62" r="0.8" fill="red" />
                    </svg>
                    
                    <div id="map-info" class="absolute bottom-4 left-4 right-4 bg-black/90 border border-red-900/50 p-3 text-[10px] backdrop-blur-md">
                        <p class="text-zinc-500 animate-pulse text-center uppercase tracking-widest">Wähle Distrikt für Scan...</p>
                    </div>
                </div>
            </div>

            <!-- NEUER TAKTISCHER BAUPLAN (EL COYOTE ROJO) -->
            <div id="tab-location" class="hidden flex-col h-full flex-1">
                <div class="relative w-full flex-1 min-h-[300px] bg-[#0a0f12] border border-cyan-900/50 rounded overflow-hidden p-2 shadow-[inset_0_0_20px_rgba(0,255,255,0.05)]">
                    <!-- Blueprint Grid Hintergrund -->
                    <div class="absolute inset-0 opacity-20" style="background-image: linear-gradient(#0ff 1px, transparent 1px), linear-gradient(90deg, #0ff 1px, transparent 1px); background-size: 20px 20px;"></div>
                    
                    <svg viewBox="0 0 200 200" class="w-full h-full relative z-10">
                        <!-- Gebäudeumriss -->
                        <rect x="20" y="20" width="160" height="160" fill="rgba(0, 0, 0, 0.6)" stroke="#0ea5e9" stroke-width="1.5" stroke-dasharray="4 2"/>
                        
                        <!-- Haupteingang -->
                        <rect x="80" y="175" width="40" height="10" fill="rgba(239, 68, 68, 0.2)" stroke="#ef4444" stroke-width="1"/>
                        <text x="100" y="193" fill="#ef4444" font-size="6" text-anchor="middle" font-family="monospace" class="uppercase font-bold">Main Entry</text>

                        <!-- Bar Tresen -->
                        <rect x="40" y="60" width="20" height="80" fill="rgba(14, 165, 233, 0.1)" stroke="#0ea5e9" stroke-width="1" />
                        <text x="50" y="100" fill="#0ea5e9" font-size="7" text-anchor="middle" transform="rotate(-90 50,100)" font-family="monospace" class="uppercase tracking-widest">Bar Counter</text>
                        
                        <!-- Tische / Booths -->
                        <rect x="130" y="50" width="40" height="20" fill="rgba(14, 165, 233, 0.05)" stroke="#0ea5e9" stroke-width="0.5"/>
                        <rect x="130" y="80" width="40" height="20" fill="rgba(14, 165, 233, 0.05)" stroke="#0ea5e9" stroke-width="0.5"/>
                        <rect x="130" y="110" width="40" height="20" fill="rgba(14, 165, 233, 0.05)" stroke="#0ea5e9" stroke-width="0.5"/>
                        <text x="150" y="45" fill="#0ea5e9" font-size="5" text-anchor="middle" font-family="monospace" class="uppercase">Seating</text>

                        <!-- VIP Hinterzimmer -->
                        <rect x="70" y="20" width="60" height="30" fill="rgba(250, 204, 21, 0.05)" stroke="#facc15" stroke-width="1" stroke-dasharray="2 2"/>
                        <text x="100" y="35" fill="#facc15" font-size="6" text-anchor="middle" font-family="monospace" class="uppercase font-bold">VIP Backroom</text>
                        
                        <!-- Target Ping (Mr. Grey) -->
                        <circle cx="100" cy="30" r="4" fill="#ef4444" class="animate-pulse" />
                        <circle cx="100" cy="30" r="1.5" fill="#fff" />
                        <text x="110" y="32" fill="#ef4444" font-size="5" font-family="monospace" class="uppercase font-bold">Signal: Grey</text>
                    </svg>

                    <!-- HUD Overlay -->
                    <div class="absolute top-4 left-4 bg-black/80 border border-cyan-900/50 p-2 text-[8px] backdrop-blur-sm z-20">
                        <p class="text-cyan-400 font-bold uppercase tracking-widest">Taktischer Scan</p>
                        <p class="text-zinc-400 mt-1">Objekt: El Coyote Rojo</p>
                    </div>
                </div>
            </div>

            <div id="tab-app" class="hidden flex-col items-center justify-center h-full flex-1 space-y-6 text-center">
                <div class="bg-white p-4 rounded-sm qr-container shadow-xl">
                    <img id="qr-code-img" src="" alt="QR Code" class="w-40 h-40">
                </div>
                <div class="bg-zinc-900 border border-zinc-800 p-2 w-full text-left hidden" id="local-file-warning">
                    <p class="text-red-500 text-[10px] font-bold">⚠️ Lokale Datei erkannt</p>
                    <p class="text-zinc-400 text-[8px]">QR-Code funktioniert nur bei Online-Hosting (z.B. GitHub Pages).</p>
                </div>
                <p id="current-url-display" class="text-[8px] text-zinc-600 italic truncate w-full"></p>
            </div>
        </div>

        <div id="nav-bar" class="hidden bg-zinc-800 flex border-t border-zinc-700 z-20 overflow-x-auto safe-bottom">
            <button onclick="switchTab('message')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center bg-red-600 text-white min-w-[70px]"><i data-lucide="book-open" class="w-4 h-4"></i> Welt</button>
            <button onclick="switchTab('comms')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="radio" class="w-4 h-4"></i> Comms</button>
            <button onclick="switchTab('map')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="map-pin" class="w-4 h-4"></i> Map</button>
            <button onclick="switchTab('location')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="layout" class="w-4 h-4"></i> LOC</button>
            <button onclick="switchTab('app')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="smartphone" class="w-4 h-4"></i> APP</button>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyAIVM2CA2XTouUUUzQOTiLNi89PkGFXPc8"; 
        let isDecrypted = false, isPlayingAudio = false, isMusicPlaying = false, audioCtx = null;

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        const bgMusic = document.getElementById('bg-music');
        const musicBars = document.querySelectorAll('.music-bar');

        function initAudioContext() {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (AudioCtx && !audioCtx) audioCtx = new AudioCtx();
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        }

        function toggleMusic() {
            if (!isDecrypted) return;
            initAudioContext();
            if (isMusicPlaying) {
                bgMusic.pause(); musicBars.forEach(b => b.classList.remove('playing')); isMusicPlaying = false;
            } else {
                bgMusic.play().then(() => { musicBars.forEach(b => b.classList.add('playing')); isMusicPlaying = true; }).catch(e => {
                    console.log("Audio Wiedergabe blockiert.");
                });
            }
        }

        async function decryptSystem() {
            initAudioContext();
            document.getElementById('datapad-frame').classList.add('glitch-active');
            setTimeout(() => {
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('tab-message').classList.remove('hidden');
                document.getElementById('nav-bar').classList.remove('hidden');
                document.getElementById('datapad-frame').classList.remove('glitch-active');
                isDecrypted = true;
                toggleMusic(); preloadGreyImage(); generateQRCode();
            }, 800);
        }

        function switchTab(tabId) {
            ['message', 'comms', 'map', 'location', 'app'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if(el) { el.classList.add('hidden'); el.classList.remove('flex'); }
            });
            const activeTab = document.getElementById(`tab-${tabId}`);
            if(activeTab) { activeTab.classList.remove('hidden'); activeTab.classList.add('flex'); }

            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => { btn.classList.remove('bg-red-600', 'text-white'); btn.classList.add('text-zinc-500'); });
            event.currentTarget.classList.add('bg-red-600', 'text-white');
            event.currentTarget.classList.remove('text-zinc-500');
            if (tabId === 'app') generateQRCode();
        }

        function generateQRCode() {
            const url = window.location.href;
            document.getElementById('current-url-display').innerText = url;
            
            if (url.startsWith('file://')) {
                document.getElementById('qr-code-img').style.display = 'none';
                document.getElementById('local-file-warning').classList.remove('hidden');
            } else {
                document.getElementById('qr-code-img').style.display = 'block';
                document.getElementById('qr-code-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}&color=000000&bgcolor=FFFFFF`;
            }
        }

        function showDistrictInfo(name, status, desc) {
            document.getElementById('map-info').innerHTML = `<p class="text-red-500 font-bold uppercase">${name} [${status}]</p><p class="text-white mt-1">${desc}</p>`;
        }

        async function preloadGreyImage() {
            const imgEl = document.getElementById('grey-image');
            if (imgEl.src && imgEl.src !== window.location.href && !imgEl.src.includes('unsplash')) return;
            
            try {
                if (!apiKey || apiKey.trim() === "") throw new Error("API Key fehlt");
                const prompt = "Hyper-detailed cyberpunk noir portrait of Mr. Grey, legendary Night City fixer. Intense glowing gray optic implants with internal binary data scrolling. Face features intricate chrome sub-dermal plating, neural link ports on neck. High-collared tactical trench coat with glowing red fiber-optic seams. Background: Rainy neon-drenched Night City alley 2045, volumetric fog, cinematic gritty lighting, Akira-style palette, 8k resolution.";
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: { prompt: prompt }, parameters: { sampleCount: 1 } })
                });
                const result = await response.json();
                const b64 = result.predictions?.[0]?.bytesBase64Encoded;
                if (b64) {
                    imgEl.src = `data:image/png;base64,${b64}`;
                    document.getElementById('comms-loading').classList.add('hidden');
                    document.getElementById('grey-feed-container').classList.remove('hidden');
                } else throw new Error("Kein Bild generiert");
            } catch (e) {
                imgEl.src = `https://images.unsplash.com/photo-1605806616949-1e87b487cb2a?q=80&w=600&auto=format&fit=crop`;
                document.getElementById('comms-loading').classList.add('hidden');
                document.getElementById('grey-feed-container').classList.remove('hidden');
            }
        }

        function createWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 32 + pcmData.length * 2, true); writeString(8, 'WAVE'); writeString(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(36, 'data');
            view.setUint32(40, pcmData.length * 2, true); let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) view.setInt16(offset, pcmData[i], true);
            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function playVoice() {
            if (isPlayingAudio) return; isPlayingAudio = true; initAudioContext();
            const originalVolume = bgMusic.volume; if (isMusicPlaying) bgMusic.volume = 0.1;
            const bars = document.querySelectorAll('.audio-bar');
            const visInt = setInterval(() => bars.forEach(b => b.style.height = `${Math.random()*24+4}px`), 100);
            
            const audioText = "Choombas, kommt ins El Coyote Rojo wenn ihr einen Auftrag wollt. Sagt am Eingang Grey schickt uns. Wenn ihr das hier hört, habt ihr entweder Talent oder ihr kennt die richtigen Leute. Beides ist gut. Aber denkt dran: Style over Substance. Kommt bewaffnet. Kommt stylisch. Wir sehen uns auf der anderen Seite.";

            try {
                if (!apiKey || apiKey.trim() === "") throw new Error("API Key fehlt");
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say in a rough, gravelly, deep human voice of a tired man who has smoked heavy cigarettes and consumed synthetic drugs for years. Gritty and human, no robotic effects: ${audioText}` }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Iapetus" } } } }
                    })
                });
                const result = await response.json();
                const b64Audio = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                const mimeType = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;
                if (!b64Audio) throw new Error();
                const binaryString = atob(b64Audio);
                const bytes = new Int16Array(binaryString.length / 2);
                for (let i = 0; i < binaryString.length; i += 2) bytes[i / 2] = (binaryString.charCodeAt(i + 1) << 8) | binaryString.charCodeAt(i);
                const wavBlob = createWav(bytes, parseInt(mimeType.match(/rate=(\d+)/)?.[1] || "24000"));
                const audio = new Audio(URL.createObjectURL(wavBlob));
                audio.onended = () => { isPlayingAudio = false; clearInterval(visInt); bars.forEach(b => b.style.height = '4px'); if (isMusicPlaying) bgMusic.volume = originalVolume; };
                audio.play();
            } catch (e) { 
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(audioText);
                    utterance.pitch = 0.2; utterance.rate = 0.8; utterance.lang = 'de-DE';
                    utterance.onend = () => { isPlayingAudio = false; clearInterval(visInt); bars.forEach(b => b.style.height = '4px'); if (isMusicPlaying) bgMusic.volume = originalVolume; };
                    window.speechSynthesis.speak(utterance);
                } else {
                    setTimeout(() => { isPlayingAudio = false; clearInterval(visInt); bars.forEach(b => b.style.height = '4px'); if (isMusicPlaying) bgMusic.volume = originalVolume; }, 8000);
                }
            }
        }
    </script>
</body>
</html>