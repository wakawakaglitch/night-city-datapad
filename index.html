<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Night City Datapad 2045</title>
    
    <!-- PWA & Mobile Meta Tags -->
    <meta name="theme-color" content="#0a0a0a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NC Datapad">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,700;1,800&display=swap');

        :root {
            --neon-red: #ff0000;
            --dark-bg: #0a0a0a;
            --zinc-900: #18181b;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--dark-bg);
            color: #ef4444;
            overflow: hidden;
            overscroll-behavior-y: contain;
        }

        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(255, 0, 0, 0.03));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.1;
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .glitch-active {
            animation: glitch 0.2s infinite;
        }

        /* Animation für Video-Effekte */
        @keyframes talking {
            0% { transform: scale(1); filter: brightness(1) contrast(1); }
            25% { transform: scale(1.005) translate(1px, -1px); filter: brightness(1.1) contrast(1.1); }
            50% { transform: scale(1) translate(-1px, 1px); filter: brightness(0.9) contrast(1); }
            100% { transform: scale(1); filter: brightness(1) contrast(1); }
        }

        .is-talking, .glitch-loc {
            animation: talking 0.1s infinite;
        }

        @keyframes flicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% { opacity: 1; }
            20%, 22%, 24%, 55% { opacity: 0.8; }
        }

        .flicker-loc {
            animation: flicker 2s infinite;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #dc2626; }

        .audio-bar {
            width: 4px;
            background-color: #dc2626;
            transition: height 0.1s ease;
        }

        .music-wave {
            display: flex;
            align-items: flex-end; gap: 1px; height: 10px;
        }
        .music-bar {
            width: 2px; background: #ef4444; height: 2px;
        }
        .music-bar.playing {
            animation: wave 0.6s infinite ease-in-out alternate;
        }
        @keyframes wave { from { height: 2px; } to { height: 10px; } }

        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        .spinner {
            border: 2px solid rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Map District Hover */
        .map-district {
            transition: all 0.2s ease;
            cursor: pointer;
            fill: rgba(255, 0, 0, 0.05);
            stroke: rgba(255, 0, 0, 0.3);
            stroke-width: 0.5;
        }
        .map-district:hover {
            fill: rgba(255, 0, 0, 0.2);
            stroke: rgba(255, 0, 0, 1);
            stroke-width: 1;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-0 sm:p-4">

    <div class="scanlines"></div>
    <div class="fixed inset-0 opacity-10 pointer-events-none" 
         style="background-image: radial-gradient(#ff0000 1px, transparent 1px); background-size: 20px 20px;"></div>

    <audio id="bg-music" loop crossorigin="anonymous">
        <source src="https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/theme.mp3" type="audio/mpeg">
    </audio>

    <div id="datapad-frame" class="relative w-full max-w-2xl bg-zinc-900 border-x-0 sm:border-4 border-zinc-800 sm:rounded-xl overflow-hidden shadow-[0_0_50px_rgba(255,0,0,0.15)] flex flex-col h-screen sm:h-[90vh]">
        
        <!-- Status Bar -->
        <div class="bg-zinc-800 p-2 safe-top flex justify-between items-center text-[10px] border-b border-red-900/50 z-20">
            <div class="flex items-center gap-4">
                <span class="flex items-center gap-1 font-bold">
                    <i data-lucide="shield-alert" class="w-3 h-3 text-red-600 animate-pulse"></i>
                    SYSTEM: RED_OS_v4.5
                </span>
            </div>
            <div class="flex items-center gap-3">
                <button id="music-btn" onclick="toggleMusic()" class="flex items-center gap-2 bg-black/40 px-2 py-1 border border-zinc-700 hover:border-red-500 transition-colors">
                    <div class="music-wave" id="music-wave-ui">
                        <div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div>
                    </div>
                    <i data-lucide="music" class="w-3 h-3"></i>
                </button>
                <i data-lucide="wifi" class="w-3 h-3"></i>
                <div class="flex items-center gap-1"><span>98%</span><i data-lucide="battery" class="w-3 h-3"></i></div>
            </div>
        </div>

        <div id="screen-content" class="flex-1 relative p-6 overflow-y-auto custom-scrollbar bg-black/40 z-10 flex flex-col">
            
            <div id="lock-screen" class="flex flex-col items-center justify-center h-full flex-1 py-20 text-center">
                <i data-lucide="lock" class="w-12 h-12 mb-4 text-red-600"></i>
                <h2 class="text-xl font-bold mb-2 uppercase italic tracking-widest">Verschlüsselt</h2>
                <button onclick="decryptSystem()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-none border border-red-400 font-bold tracking-widest transition-all active:scale-95 shadow-lg">
                    INITIALISIEREN
                </button>
            </div>

            <!-- HOME Tab Content -->
            <div id="tab-home" class="hidden flex-col space-y-6 flex-1">
                <div class="border-l-4 border-red-600 pl-4 py-2 bg-red-950/20">
                    <h1 class="text-2xl sm:text-3xl font-black italic uppercase leading-none tracking-tighter text-red-500">SYSTEM // WELTSTATUS 2045</h1>
                </div>
                
                <div class="space-y-4 text-sm sm:text-base leading-relaxed text-red-400/90">
                    <p class="font-bold text-white uppercase tracking-wider">Willkommen in der Zeit des Rots.</p>
                    <p>
                        Ihr lebt in einer Stadt, die eine nukleare Explosion überstanden hat und trotzdem weiter Geschäfte macht. Der Himmel ist noch rot von alten Sünden, aber das Geld ist immer noch grün.
                    </p>
                    <p>
                        Regierungen sind schwach, Konzerne hungrig. Das alte NET ist tot, ersetzt durch lokale Datenpools. Wer überleben will, muss sich anpassen – oder genug Chrome besitzen, um sich den Weg freizuschießen.
                    </p>
                </div>

                <div class="bg-zinc-900 border border-zinc-700 p-4 text-[11px] sm:text-sm space-y-3 mt-4">
                    <p class="text-white uppercase font-black tracking-widest border-b border-zinc-700 pb-2 mb-2">>> AKTUELLER TREFFPUNKT_</p>
                    <div class="grid grid-cols-1 gap-2">
                        <p><span class="text-zinc-500 w-24 inline-block uppercase font-bold text-[10px]">Sektor:</span> Heywood - Santo Domingo</p>
                        <p><span class="text-zinc-500 w-24 inline-block uppercase font-bold text-[10px]">Lokalität:</span> „El Coyote Rojo" (Hinterzimmer)</p>
                        <p><span class="text-zinc-500 w-24 inline-block uppercase font-bold text-[10px]">Zeit:</span> 22:00 Uhr // Morgen</p>
                        <p><span class="text-zinc-500 w-24 inline-block uppercase font-bold text-[10px]">Codewort:</span> <span class="text-white italic">"Grey schickt mich."</span></p>
                    </div>
                </div>

                <div class="bg-red-600/20 border border-red-500 p-4 font-bold italic shadow-lg text-sm sm:text-base text-center">
                    <p class="text-white">Kommt bewaffnet. Kommt nicht zu spät.</p>
                    <p class="text-[10px] text-red-700 not-italic mt-2 uppercase tracking-[0.3em]">Reputation ist alles.</p>
                </div>
            </div>

            <!-- COMMS Tab Content -->
            <div id="tab-comms" class="hidden flex-col space-y-4 flex-1">
                <div class="relative aspect-video w-full bg-black border-2 border-zinc-800 rounded overflow-hidden flex items-center justify-center">
                    <div id="image-loader" class="flex flex-col items-center gap-3 text-red-500">
                        <div class="spinner"></div>
                        <span class="text-[10px] animate-pulse uppercase tracking-widest font-bold">Signal-Aufbau...</span>
                    </div>
                    <div id="grey-feed-container" class="hidden absolute inset-0">
                        <img id="grey-image" src="" alt="Mr. Grey" class="w-full h-full object-cover grayscale opacity-70 transition-all">
                        <div class="absolute inset-0 bg-red-900/10 mix-blend-overlay"></div>
                    </div>
                </div>

                <div class="bg-zinc-900/80 border border-zinc-800 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <button onclick="playVoice()" class="p-4 bg-red-600 rounded-full text-white hover:bg-red-500 shadow-[0_0_15px_rgba(255,0,0,0.4)]">
                                <i data-lucide="play" class="w-6 h-6 fill-current"></i>
                            </button>
                            <button onclick="stopVoice()" class="p-3 bg-zinc-800 border border-zinc-700 rounded-full text-zinc-400">
                                <i data-lucide="square" class="w-4 h-4 fill-current"></i>
                            </button>
                            <div class="flex flex-col">
                                <p class="text-xs font-bold text-red-500 uppercase">Crypt-Vox Feed</p>
                                <p class="text-[8px] text-zinc-500">ID: GREY_REDUX_V2</p>
                            </div>
                        </div>
                        <div id="visualizer" class="flex gap-1 h-8 items-end">
                            <div class="audio-bar h-1"></div><div class="audio-bar h-1"></div><div class="audio-bar h-1"></div><div class="audio-bar h-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MAP Tab Content -->
            <div id="tab-map" class="hidden flex-col h-full flex-1">
                <div class="relative w-full flex-1 min-h-[400px] bg-zinc-950 border border-zinc-800 rounded overflow-hidden shadow-inner">
                    <div id="map-loader" class="absolute inset-0 flex flex-col items-center justify-center text-red-500 z-20">
                        <div class="spinner"></div>
                        <span class="text-[10px] animate-pulse mt-2 uppercase">Karten-Sync...</span>
                    </div>
                    
                    <div id="city-map-container" class="hidden absolute inset-0">
                        <img id="city-map-img" src="" alt="Night City Top-Down" class="w-full h-full object-cover opacity-60 grayscale brightness-75">
                        <div class="absolute inset-0 bg-red-900/5 mix-blend-color"></div>
                        <div class="absolute inset-0 opacity-20 pointer-events-none" style="background-image: linear-gradient(rgba(255,0,0,0.2) 1px, transparent 1px), linear-gradient(90deg, rgba(255,0,0,0.2) 1px, transparent 1px); background-size: 40px 40px;"></div>
                        <svg viewBox="0 0 100 120" class="absolute inset-0 w-full h-full z-10" preserveAspectRatio="none">
                            <path d="M 30 5 L 70 5 L 80 30 L 60 40 L 25 35 Z" class="map-district" onclick="showDistrictInfo('Watson', 'INDUSTRIE', 'Ehemaliges Arasaka-Zentrum. Jetzt Baustellen und Fabriken.')"/>
                            <path d="M 70 5 L 95 20 L 90 60 L 70 55 L 80 30 Z" class="map-district" onclick="showDistrictInfo('Westbrook', 'WOHLZUSTAND', 'Japantown und Charter Hill. Reiche Enklaven.')"/>
                            <path d="M 40 40 L 60 40 L 70 55 L 50 65 L 30 55 Z" class="map-district" onclick="showDistrictInfo('City Center', 'RADIOAKTIV', 'Ground Zero der Nuke. Wiederaufbau-Zone.')"/>
                            <path d="M 25 55 L 50 65 L 55 85 L 20 80 Z" class="map-district" onclick="showDistrictInfo('Heywood', 'ÜBERFÜLLT', 'Santo Domingo und Vista del Rey. Heimat des Coyote Rojo.')"/>
                            <path d="M 10 80 L 30 85 L 40 110 L 15 115 Z" class="map-district" onclick="showDistrictInfo('Pacifica', 'KAMPFZONE', 'Gesetzloses Territorium. Voodoo Boys Territorium.')"/>
                            <g class="animate-pulse"><circle cx="45" cy="75" r="2" fill="none" stroke="#ef4444" stroke-width="0.5" /><circle cx="45" cy="75" r="0.8" fill="#ef4444" /></g>
                        </svg>
                    </div>
                    <div id="map-info" class="absolute bottom-4 left-4 right-4 bg-black/90 border border-red-900/50 p-3 text-[10px] backdrop-blur-md text-center text-zinc-500 uppercase tracking-widest font-bold">Wähle Sektor für Aufklärung...</div>
                </div>
            </div>

            <!-- LOC Tab Content -->
            <div id="tab-location" class="hidden flex-col space-y-4 flex-1">
                <div class="relative aspect-video w-full bg-black border-2 border-zinc-800 rounded overflow-hidden flex items-center justify-center">
                    <div id="loc-loader" class="flex flex-col items-center gap-3 text-red-500 z-20">
                        <div class="spinner"></div>
                        <span class="text-[10px] animate-pulse uppercase tracking-widest font-bold">Top-Down Scan...</span>
                    </div>
                    <div id="loc-image-container" class="hidden absolute inset-0 flicker-loc">
                        <img id="loc-image" src="" alt="El Coyote Rojo Grundriss" class="w-full h-full object-cover grayscale opacity-60 glitch-loc">
                        <svg viewBox="0 0 100 100" class="absolute inset-0 w-full h-full z-10">
                            <circle cx="82" cy="25" r="4" fill="none" stroke="#ef4444" stroke-width="0.5" class="animate-pulse" />
                            <text x="70" y="35" fill="#ef4444" font-size="3.5" font-family="monospace" class="font-bold uppercase tracking-tighter">TARGET: GREY</text>
                        </svg>
                    </div>
                </div>
                <div class="bg-zinc-900 border border-zinc-700 p-3 text-[9px] uppercase"><p class="text-white font-bold">Grundriss-Analyse:</p><p class="text-zinc-500">Ziel im VIP-Sektor. Wärmesignatur stabil.</p></div>
            </div>

            <!-- APP Tab Content -->
            <div id="tab-app" class="hidden flex-col items-center justify-center h-full flex-1 space-y-4">
                <div class="bg-white p-4 rounded-sm qr-container shadow-xl"><div id="qr-code-img"></div></div>
            </div>
        </div>

        <!-- Navigation Bar -->
        <div id="nav-bar" class="hidden bg-zinc-800 flex border-t border-zinc-700 z-20 overflow-x-auto safe-bottom">
            <button onclick="switchTab('home')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center bg-red-600 text-white min-w-[70px]"><i data-lucide="home" class="w-4 h-4"></i> Home</button>
            <button onclick="switchTab('comms')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="radio" class="w-4 h-4"></i> Comms</button>
            <button onclick="switchTab('map')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="map-pin" class="w-4 h-4"></i> Map</button>
            <button onclick="switchTab('location')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="layout" class="w-4 h-4"></i> LOC</button>
            <button onclick="switchTab('app')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="smartphone" class="w-4 h-4"></i> APP</button>
        </div>
    </div>

    <script>
        const apiKey = "";
        let isDecrypted = false, audioCtx = null, currentAudio = null, isPlayingVoice = false;

        if (typeof lucide !== 'undefined') lucide.createIcons();

        function initAudioContext() {
            const AudioCtx = window.AudioContext || window.webkitAudioContext;
            if (AudioCtx && !audioCtx) audioCtx = new AudioCtx();
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
        }

        async function generateImages() {
            const greyPrompt = "Cyberpunk fixer Mr. Grey, male, heavy chrome facial implants, glowing silver optic sensors, gritty noir lighting, 8k resolution.";
            const locPrompt = "Top down tactical floor plan view of a cyberpunk bar interior, red neon lines, blueprint style layout, Night City 2045.";
            const cityPrompt = "Top down tactical satellite map of Night City 2045, glowing neon red grid, districts outlined, blueprint aesthetic, highly detailed urban layout.";
            
            try {
                const [resGrey, resLoc, resMap] = await Promise.all([
                    fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ instances: { prompt: greyPrompt }, parameters: { sampleCount: 1 } })
                    }),
                    fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ instances: { prompt: locPrompt }, parameters: { sampleCount: 1 } })
                    }),
                    fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ instances: { prompt: cityPrompt }, parameters: { sampleCount: 1 } })
                    })
                ]);

                const [dataGrey, dataLoc, dataMap] = await Promise.all([resGrey.json(), resLoc.json(), resMap.json()]);

                if (dataGrey.predictions?.[0]?.bytesBase64Encoded) {
                    document.getElementById('grey-image').src = `data:image/png;base64,${dataGrey.predictions[0].bytesBase64Encoded}`;
                    document.getElementById('image-loader').classList.add('hidden');
                    document.getElementById('grey-feed-container').classList.remove('hidden');
                }
                if (dataLoc.predictions?.[0]?.bytesBase64Encoded) {
                    document.getElementById('loc-image').src = `data:image/png;base64,${dataLoc.predictions[0].bytesBase64Encoded}`;
                    document.getElementById('loc-loader').classList.add('hidden');
                    document.getElementById('loc-image-container').classList.remove('hidden');
                }
                if (dataMap.predictions?.[0]?.bytesBase64Encoded) {
                    document.getElementById('city-map-img').src = `data:image/png;base64,${dataMap.predictions[0].bytesBase64Encoded}`;
                    document.getElementById('map-loader').classList.add('hidden');
                    document.getElementById('city-map-container').classList.remove('hidden');
                }
            } catch (e) {
                document.querySelectorAll('.spinner').forEach(s => s.parentElement.classList.add('hidden'));
                document.querySelectorAll('.hidden').forEach(h => h.classList.remove('hidden'));
            }
        }

        async function decryptSystem() {
            initAudioContext();
            document.getElementById('datapad-frame').classList.add('glitch-active');
            generateImages();
            setTimeout(() => {
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('tab-home').classList.remove('hidden');
                document.getElementById('tab-home').classList.add('flex');
                document.getElementById('nav-bar').classList.remove('hidden');
                document.getElementById('datapad-frame').classList.remove('glitch-active');
                isDecrypted = true;
                generateQRCode();
            }, 800);
        }

        function switchTab(tabId) {
            ['home', 'comms', 'map', 'location', 'app'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if(el) { el.classList.add('hidden'); el.classList.remove('flex'); }
            });
            const activeTab = document.getElementById(`tab-${tabId}`);
            if(activeTab) { activeTab.classList.remove('hidden'); activeTab.classList.add('flex'); }
            document.querySelectorAll('.nav-btn').forEach(btn => { 
                btn.classList.remove('bg-red-600', 'text-white'); btn.classList.add('text-zinc-500'); 
            });
            event.currentTarget.classList.add('bg-red-600', 'text-white');
            event.currentTarget.classList.remove('text-zinc-500');
        }

        function showDistrictInfo(name, status, desc) {
            document.getElementById('map-info').innerHTML = `<p class="text-red-500 font-bold uppercase">${name} [${status}]</p><p class="text-white mt-1 leading-tight">${desc}</p>`;
        }

        function stopVoice() {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            isPlayingVoice = false;
            document.getElementById('grey-image').classList.remove('is-talking');
            document.querySelectorAll('.audio-bar').forEach(b => b.style.height = '4px');
        }

        async function playVoice() {
            if (isPlayingVoice) return;
            isPlayingVoice = true;
            initAudioContext();
            const msg = "Choombas, willkommen in Night City. Ich bin Mr. Grey. Ihr wollt Arbeit? Dann kommt zum El Coyote Rojo. Heywood, Santo Domingo Sektor. Kommt bewaffnet, kommt stylisch. Aber kommt nicht zu spät. Style over Substance, Choom.";
            const voiceBars = document.querySelectorAll('.audio-bar');
            const visInt = setInterval(() => {
                if(!isPlayingVoice) { clearInterval(visInt); return; }
                voiceBars.forEach(b => b.style.height = `${Math.random()*28+4}px`);
            }, 100);

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say in an extremely raspy, deep, cigarette-burnt human voice, sounding exhausted and gravelly: ${msg}` }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Iapetus" } } } }
                    })
                });
                const result = await response.json();
                const b64Audio = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                const mimeType = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;
                if (b64Audio) {
                    const binaryString = atob(b64Audio);
                    const bytes = new Int16Array(binaryString.length / 2);
                    for (let i = 0; i < binaryString.length; i += 2) bytes[i / 2] = (binaryString.charCodeAt(i + 1) << 8) | binaryString.charCodeAt(i);
                    const wavBlob = createWav(bytes, parseInt(mimeType.match(/rate=(\d+)/)?.[1] || "24000"));
                    currentAudio = new Audio(URL.createObjectURL(wavBlob));
                    document.getElementById('grey-image').classList.add('is-talking');
                    currentAudio.onended = () => stopVoice();
                    currentAudio.play();
                }
            } catch (e) { isPlayingVoice = false; clearInterval(visInt); }
        }

        function createWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 32 + pcmData.length * 2, true); writeString(8, 'WAVE'); writeString(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(36, 'data');
            view.setUint32(40, pcmData.length * 2, true); let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) view.setInt16(offset, pcmData[i], true);
            return new Blob([buffer], { type: 'audio/wav' });
        }

        function generateQRCode() {
            const url = window.location.href;
            if (!url.startsWith('file://')) {
                document.getElementById('qr-code-img').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}" class="w-40 h-40">`;
            } else {
                document.getElementById('qr-code-img').innerHTML = "<p class='text-[10px] text-zinc-500 uppercase'>QR-Code nur online verfügbar</p>";
            }
        }
    </script>
</body>
</html>